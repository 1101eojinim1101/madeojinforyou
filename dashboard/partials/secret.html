
<div class="content">
    <!-- ====== ë¹„ë°€ ì¹œêµ¬ ì„¹ì…˜ ì‹œì‘ ====== -->
    <div id="secret" class="section">
      <!-- ì„œë¸Œíƒ­ -->
      <div class="subtabs">
        <button class="subtab active" data-target="attendance">ê°ì • ì¶œì„ë¶€</button>
        <button class="subtab"       data-target="diary">ì¼ê¸° ì“°ê¸°</button>
      </div>
  
      <!-- ì„œë¸Œì½˜í…ì¸  -->
      <div class="subcontent">
        <!-- 1) ê°ì • ì¶œì„ë¶€ -->
        <div id="attendance" class="subsection active">
          <h3>
            ê°ì • ì¶œì„ë¶€ â€“
            <input type="date" id="attDateInput"
                   style="margin-left:0.5rem; padding:0.3rem;" />
          </h3>
          <div class="emotion-grid"></div>
  
          <div id="attReason" class="attendance-reason"
               style="display:none; margin-top:1rem;">
            <input id="reasonInput"
                   type="text" maxlength="20"
                   placeholder="ë„¤ ë§ˆìŒì˜ ì´ìœ ê°€ ê¶ê¸ˆí•´. ë‚˜ì—ê²Œë§Œ ì•Œë ¤ì¤˜ğŸ¤«"
                   style="width:100%; margin-bottom:0.5rem; padding:0.5rem;" />
            <button id="checkBtn"
                    style="padding:0.6em 1.2em;
                           background:#64b5f6; color:#fff;
                           border:none; border-radius:6px;
                           cursor:pointer;">
              ì¶œì„ ì²´í¬
            </button>
          </div>
  
          <h4 style="margin-top:1.5rem;">ì¶œì„ ê¸°ë¡</h4>
          <ul id="attendanceList"
              style="list-style:none; padding:0; margin-top:0.5rem;"></ul>
        </div>
  
        <!-- 2) ì¼ê¸° ì“°ê¸° -->
        <div id="diary" class="subsection">
          <div class="diary-header"
               style="display:flex;
                      justify-content:space-between;
                      align-items:center;
                      margin-bottom:1rem;">
            <h3>ì¼ê¸° ì“°ê¸°</h3>
            <button id="newDiaryBtn"
                    style="padding:0.5rem 1rem;
                           background:#64b5f6; color:#fff;
                           border:none; border-radius:6px;
                           cursor:pointer;">
              ìƒˆ ì¼ê¸° ì“°ê¸°
            </button>
          </div>
  
          <!-- 2.1) ì¼ê¸° ëª©ë¡ -->
          <div id="diaryList" class="diary-list"></div>
  
          <!-- 2.2) ìƒˆ ì¼ê¸° ì“°ê¸° í¼ -->
          <div id="diaryForm" class="diary-form"
               style="display:none; max-width:500px; margin-bottom:1rem;">
            <input id="diaryDate" type="date"
                   style="width:100%; margin-bottom:0.5rem; padding:0.5rem;" />
            <select id="diaryEmotion"
                    style="width:100%; margin-bottom:0.5rem; padding:0.5rem;"></select>
            <textarea id="diaryText" rows="6"
                      placeholder="ë„ˆì˜ ê°ì •ê³¼ ê²½í—˜ì„ ì†”ì§í•˜ê²Œ ì¨ë´. ë„ˆë¥¼ í‰ê°€í•˜ê±°ë‚˜ íŒë‹¨í•˜ì§€ ì•Šì„ê²Œ."
                      style="width:100%; padding:0.5rem; margin-bottom:0.5rem;"></textarea>
            <button id="saveDiaryBtn"
                    style="padding:0.6em 1.2em;
                           background:#64b5f6; color:#fff;
                           border:none; border-radius:6px;
                           cursor:pointer;">
              ì €ì¥
            </button>
          </div>
  
          <!-- 2.3) ì¼ê¸° ë³´ê¸° -->
          <div id="diaryView" class="diary-view"
               style="display:none; max-width:800px; margin:0 auto;">
            <button id="backDiaryBtn"
                    style="margin-bottom:1rem; padding:0.4rem 0.8rem;
                           background:#aaa; color:#fff;
                           border:none; border-radius:4px;
                           cursor:pointer;">
              ëª©ë¡ìœ¼ë¡œ
            </button>
  
            <div class="view-container" style="display:flex; gap:1rem;">
              <!-- ì›ë³¸ -->
              <div class="view-col" style="flex:1; padding:1rem;
                                            border-right:2px dashed #ccc;">
                <h5>ğŸ“ ì†ë‹¥ì†ë‹¥ (ì›ë³¸)</h5>
                <p id="viewOriginal" style="white-space:pre-wrap;"></p>
              </div>
              <!-- AI ì œì•ˆ -->
              <div class="view-col" style="flex:1; padding:1rem;
                                            border-right:2px dashed #ccc;">
                <h5>ğŸ’¡ AI ì œì•ˆ</h5>
                <p id="viewAI" style="white-space:pre-wrap;">ì—†ìŒ</p>
              </div>
              <!-- ìµœì¢…ë³¸ -->
              <div class="view-col" style="flex:1; padding:1rem;">
                <h5>âœ… ìµœì¢…ë³¸</h5>
                <canvas id="finalCanvas" width="300" height="200"
                        style="border:1px solid #ddd; margin-bottom:0.5rem;"></canvas>
                <button id="submitFinalBtn"
                        style="display:block; width:100%; padding:0.6em;
                               background:#64b5f6; color:#fff;
                               border:none; border-radius:6px;
                               cursor:pointer;">
                  ìµœì¢… ì œì¶œ
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- ì„œë¸Œì½˜í…ì¸  ë‹«ê¸° -->
    </div>
    <!-- #secret ë -->
  </div>
  <!-- .content ë -->
  
  <style>
    .subtabs {
      display: flex; border-bottom:2px solid #ddd; margin-bottom:1rem;
    }
    .subtab {
      flex:1; padding:0.75rem; background:none; border:none;
      border-bottom:3px solid transparent; font-size:1rem; cursor:pointer;
    }
    .subtab.active {
      border-color:#64b5f6; color:#64b5f6;
    }
    .subcontent .subsection { display:none; }
    .subcontent .subsection.active { display:block; }
  
    .emotion-grid {
      display:grid; grid-template-columns:repeat(5,1fr);
      gap:0.75rem; margin-bottom:1rem;
    }
    .emotion-cell {
      display:flex; flex-direction:column; align-items:center;
      padding:0.75rem; border:1px solid #ccc; border-radius:8px;
      cursor:pointer; transition:background .2s, border-color .2s;
    }
    .emotion-cell.selected {
      background:rgba(100,181,246,0.2); border-color:#64b5f6;
    }
    .attendance-reason input { font-size:1rem; }
  
    .diary-list button {
      display:block; width:100%; text-align:left; padding:0.5rem;
      margin-bottom:0.25rem; border:1px solid #ccc; background:#fff;
      cursor:pointer; border-radius:4px;
    }
  </style>
  
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const studentId = localStorage.getItem('studentId');
    if (!studentId) return location.href='index.html';
  
    // ë‚ ì§œ ì…ë ¥
    const dateInput = document.getElementById('attDateInput');
    dateInput.value = new Date().toISOString().split('T')[0];
    dateInput.addEventListener('change', loadAttendance);
  
    // íƒ­ ì „í™˜
    document.querySelectorAll('.subtab').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.subtab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.subsection').forEach(sec=>sec.classList.remove('active'));
        document.getElementById(btn.dataset.target).classList.add('active');
      });
    });
  
    // ê°ì • ëª©ë¡
    const emotions = [
      {emoji:'ğŸ˜€',label:'ê¸°ì¨'},{emoji:'ğŸ˜„',label:'í–‰ë³µ'},{emoji:'ğŸ˜',label:'ì‚¬ë‘'},
      {emoji:'ğŸ˜Œ',label:'ì°¨ë¶„'},{emoji:'ğŸ˜‚',label:'ì¬ë¯¸'},{emoji:'ğŸ¤©',label:'ì„¤ë ˜'},
      {emoji:'ğŸ˜Š',label:'ë§Œì¡±'},{emoji:'ğŸ˜‰',label:'ì¥ë‚œ'},{emoji:'ğŸ˜œ',label:'ìœ ì¾Œ'},
      {emoji:'ğŸ˜',label:'í‰ë²”'},{emoji:'ğŸ˜',label:'ìŠ¬í””'},{emoji:'ğŸ˜­',label:'ëˆˆë¬¼'},
      {emoji:'ğŸ˜¡',label:'í™”ë‚¨'},{emoji:'ğŸ˜±',label:'ê³µí¬'},{emoji:'ğŸ˜´',label:'í”¼ê³¤'},
      {emoji:'ğŸ¤”',label:'ê³ ë¯¼'},{emoji:'ğŸ˜•',label:'í˜¼ë€'},{emoji:'ğŸ˜',label:'ìì‹ ê°'},
      {emoji:'ğŸ˜”',label:'ìš°ìš¸'},{emoji:'ğŸ˜“',label:'ìŠ¤íŠ¸ë ˆìŠ¤'},{emoji:'ğŸ˜‡',label:'ì•ˆë„'},
      {emoji:'ğŸ¤—',label:'ì¹œê·¼'},{emoji:'ğŸ¤’',label:'ì•„í””'},{emoji:'ğŸ˜¶',label:'ë¬´ê°ê°'},
      {emoji:'ğŸ™',label:'ê°ì‚¬'}
    ];
  
    // ì¶œì„ ê¸°ë¡ ë¡œë“œ
    function loadAttendance() {
      const list = document.getElementById('attendanceList');
      list.innerHTML = '';
      const prefix = `attendance_${studentId}_`;
      Object.keys(localStorage)
        .filter(key => key.startsWith(prefix))
        .sort()
        .forEach(key => {
          const { emoji, label, reason } = JSON.parse(localStorage.getItem(key));
          const date = key.replace(prefix, '');
          const li = document.createElement('li');
          li.style.padding = '0.4rem 0';
          li.innerText = `${date} â€“ ${emoji} ${label} â€“ ${reason}`;
          list.appendChild(li);
        });
    }
  
    // ê°ì • ê·¸ë¦¬ë“œ ìƒì„±
    const grid = document.querySelector('.emotion-grid');
    emotions.forEach(({emoji,label}) => {
      const cell = document.createElement('div');
      cell.className = 'emotion-cell';
      cell.innerHTML = `<div class="emo-emoji">${emoji}</div><div>${label}</div>`;
      grid.appendChild(cell);
      cell.addEventListener('click', () => {
        document.querySelectorAll('.emotion-cell').forEach(c=>c.classList.remove('selected'));
        cell.classList.add('selected');
        document.getElementById('attReason').style.display = 'block';
        document.getElementById('attReason').scrollIntoView({ behavior:'smooth' });
        // ê°ì • ì €ì¥
        const key = `attendance_${studentId}_${dateInput.value}`;
        localStorage.setItem(key, JSON.stringify({ emoji, label }));
      });
    });
  
    // ì¶œì„ ì²´í¬
    document.getElementById('checkBtn').addEventListener('click', () => {
      const sel = document.querySelector('.emotion-cell.selected');
      const reason = document.getElementById('reasonInput').value.trim();
      if (!sel) return alert('ê°ì •ì„ ì„ íƒí•˜ì„¸ìš”.');
      if (!reason) return alert('ì´ìœ ë¥¼ ì‘ì„±í•˜ì„¸ìš”.');
      const key = `attendance_${studentId}_${dateInput.value}`;
      const base = JSON.parse(localStorage.getItem(key));
      localStorage.setItem(key, JSON.stringify({ ...base, reason }));
      alert('ì¶œì„ ì²´í¬ ì™„ë£Œ!');
      sel.classList.remove('selected');
      document.getElementById('reasonInput').value = '';
      document.getElementById('attReason').style.display = 'none';
      loadAttendance();
    });
  
    // ì¼ê¸° íƒ­ ë¡œì§ ì´ˆê¸°í™”
    const diaryList   = document.getElementById('diaryList');
    const diaryForm   = document.getElementById('diaryForm');
    const diaryView   = document.getElementById('diaryView');
    const newBtn      = document.getElementById('newDiaryBtn');
    const formDate    = document.getElementById('diaryDate');
    const formEmo     = document.getElementById('diaryEmotion');
    const formText    = document.getElementById('diaryText');
    const saveDiary   = document.getElementById('saveDiaryBtn');
    const backDiary   = document.getElementById('backDiaryBtn');
    const submitFinal = document.getElementById('submitFinalBtn');
  
    // ê°ì • ì˜µì…˜ ì±„ìš°ê¸°
    emotions.forEach(({emoji,label}) => {
      const o = document.createElement('option');
      o.value = label;
      o.innerText = `${emoji} ${label}`;
      formEmo.appendChild(o);
    });
  
    // ì¼ê¸° ëª©ë¡ ë¡œë“œ
    function loadDiaryList() {
      diaryList.innerHTML = '';
      const prefix = `diary_${studentId}_`;
      Object.keys(localStorage)
        .filter(k => k.startsWith(prefix))
        .sort().reverse()
        .forEach(k => {
          const { date, emotion, text } = JSON.parse(localStorage.getItem(k));
          const btn = document.createElement('button');
          btn.innerText = `${date} â€“ ${text.slice(0,8)}...`;
          btn.addEventListener('click', () => viewEntry(k));
          diaryList.appendChild(btn);
        });
    }
  
    // ì¼ê¸° ë³´ê¸°
    function viewEntry(key) {
      const data = JSON.parse(localStorage.getItem(key));
      diaryList.style.display = 'none';
      diaryForm.style.display = 'none';
      diaryView.style.display = 'block';
      document.getElementById('viewDate').innerText    = data.date;
      document.getElementById('viewEmotion').innerText = data.emotion;
      document.getElementById('viewOriginal').innerText= data.text;
      document.getElementById('viewAI').innerText       = data.aiSuggestion || 'ì—†ìŒ';
      document.getElementById('viewFinal').innerText    = data.finalContent || 'ì—†ìŒ';
    }
  
    // ìƒˆ ì¼ê¸° ì‘ì„±
    newBtn.addEventListener('click', () => {
      diaryList.style.display = 'none';
      diaryView.style.display = 'none';
      diaryForm.style.display = 'block';
      formDate.value = dateInput.value;
      const att = JSON.parse(localStorage.getItem(`attendance_${studentId}_${dateInput.value}`) || '{}');
      formEmo.value = att.label || '';
      formText.value = '';
    });
  
    // ì¼ê¸° ì €ì¥
    saveDiary.addEventListener('click', () => {
      const date    = formDate.value;
      const emotion = formEmo.value;
      const text    = formText.value.trim();
      if (!date || !emotion || !text) return alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
      const key = `diary_${studentId}_${date}_${Date.now()}`;
      localStorage.setItem(key, JSON.stringify({
        date, emotion, text, aiSuggestion:'', finalContent:''
      }));
      alert('ì¼ê¸° ì €ì¥ ì™„ë£Œ!');
      diaryForm.style.display = 'none';
      loadDiaryList();
      diaryList.style.display = 'block';
    });
  
    // ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
    backDiary.addEventListener('click', () => {
      diaryView.style.display = 'none';
      diaryForm.style.display = 'none';
      diaryList.style.display = 'block';
    });
  
    // ìµœì¢…ë³¸ ì œì¶œ
    submitFinal.addEventListener('click', () => {
      const dataURL = document.getElementById('finalCanvas').toDataURL();
      const key = `diaryFinal_${studentId}_${document.getElementById('viewDate').innerText}`;
      localStorage.setItem(key, dataURL);
      alert('ìµœì¢…ë³¸ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.');
    });
  
    // ì´ˆê¸° ë¡œë“œ
    loadAttendance();
    loadDiaryList();
  });
  </script>
  